rules_version = '2';
service cloud.firestore {
  // DEV-optimized rules: keep it simple to validate the flow.
  // Important: tighten these before production (owner checks, field guards).
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }

    // User profile remains owner-scoped even in dev.
    match /userProfiles/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Progress facts attached to a user id.
    match /userProgressFacts/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Snapshots and journeys: owner-only access. Allow create if profileId matches auth uid.
    // Accept either `evaluation` or legacy `answers`, and flexible timestamps.
    match /userIntentSnapshots/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    match /userJourneys/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    // Assessments: allow read/write for signed-in users in dev.
    match /userAbilityAssessments/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }
    match /userIntentAssessments/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }
    match /userKnowledgeAssessments/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }
    match /userQuestSuggestions/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    // Suggestions/inputs: relax limits during dev; require auth only.
    match /userInterests/{doc} {
      allow read, write: if signedIn();
    }
    match /userSuggestions/{docId} {
      allow read, write: if signedIn();
    }
    match /usersInterests/{docId} {
      allow read, write: if signedIn();
    }
    match /usersinterests/{docId} {
      allow read, write: if signedIn();
    }

    // Public signups and unsubscribes can be open.
    match /signups/{doc} {
      allow create: if true;
    }
    match /emailUnsubscribes/{doc} {
      allow create: if true;
    }

    // Fallback: deny everything else.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
