rules_version = '2';
service cloud.firestore {
  // DEV-optimized rules: keep it simple to validate the flow.
  // Important: tighten these before production (owner checks, field guards).
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }
    function isValidSessionType(v) { return v == null || v == 'individual' || v == 'group'; }
    function isValidSelection(v) { return v == null || v == 'none' || v == 'individual' || v == 'group'; }
    function isValidLang(lang) { return lang == 'ro' || lang == 'en'; }
    function hasTimestamp(field) { return field == null || field is timestamp; }
    function isValidJournal(text) { return text is string && text.size() > 0 && text.size() <= 1000; }

    // User profile remains owner-scoped even in dev.
    match /userProfiles/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidSelection(request.resource.data.selection);
    }

    // Progress facts attached to a user id.
    match /userProgressFacts/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) &&
        // If recommendation block is present, enforce allowed path values
        isValidSessionType(request.resource.data.recommendation.selectedPath) &&
        isValidSessionType(request.resource.data.recommendation.suggestedPath);
    }

    // Journals: owner-only, no extra field constraints
    match /userJournals/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId);

      match /entries/{entryId} {
        allow read, create: if isOwner(userId);
        allow update, delete: if isOwner(userId);
      }
    }

    // Snapshots and journeys: owner-only access. Allow create if profileId matches auth uid.
    // Accept either `evaluation` or legacy `answers`, and flexible timestamps.
    match /userIntentSnapshots/{docId} {
      allow create: if signedIn() &&
        request.resource.data.profileId == request.auth.uid &&
        isValidLang(request.resource.data.lang) &&
        hasTimestamp(request.resource.data.timestamp);
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    match /userJourneys/{docId} {
      allow create: if signedIn() &&
        request.resource.data.profileId == request.auth.uid &&
        isValidSessionType(request.resource.data.choice) &&
        isValidLang(request.resource.data.lang) &&
        hasTimestamp(request.resource.data.timestamp);
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    // Assessments: allow read/write for signed-in users in dev.
    match /userAbilityAssessments/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }
    match /userIntentAssessments/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }
    match /userKnowledgeAssessments/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }
    match /userQuestSuggestions/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    // Suggestions/inputs: enforce basic validation.
    match /userInterests/{doc} {
      allow create: if signedIn() &&
        isValidJournal(request.resource.data.text) &&
        isValidLang(request.resource.data.lang);
      allow read: if signedIn();
      allow update, delete: if false;
    }
    match /userSuggestions/{docId} {
      allow read, write: if signedIn();
    }
    match /usersInterests/{docId} {
      allow read, write: if signedIn();
    }
    match /usersinterests/{docId} {
      allow read, write: if signedIn();
    }

    // Public signups and unsubscribes can be open.
    match /signups/{doc} {
      allow create: if true;
    }
    match /emailUnsubscribes/{doc} {
      allow create: if true;
    }

    function isAdmin() { return signedIn() && request.auth.token.admin == true; }

    // Insights: public read, admin-only writes
    match /insights/{theme} {
      // Allow everyone to read insights
      allow read: if true;
      // Writes require admin custom claim. Use backend or temporarily grant claim for seeding.
      allow create, update, delete: if isAdmin();
    }

    // Kuno practice attempts (dev): owner-only
    match /kunoAttempts/{docId} {
      allow create: if signedIn() && request.resource.data.profileId == request.auth.uid;
      allow read, update, delete: if signedIn() && resource.data.profileId == request.auth.uid;
    }

    // Kuno tests summary per profile
    match /cunoTests/{docId} {
      allow read: if isOwner(docId);
      allow create, update: if isOwner(docId);
    }

    // User recommendations: owner-only access
    match /userRecommendations/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId);
      match /items/{recId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId);
      }
    }

    // Fallback: deny everything else.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
