rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function profileMatch() {
      return signedIn()
        && request.resource.data.profileId is string
        && request.resource.data.profileId == request.auth.uid;
    }

    function langAllowed() {
      return request.resource.data.lang in ['ro', 'en'];
    }

    match /userInterests/{doc} {
      allow read: if signedIn();
      allow create: if signedIn()
        && request.resource.data.text is string
        && request.resource.data.text.size() <= 200;
    }

    match /signups/{doc} {
      allow create: if true;
    }

    match /userProfiles/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /userIntentSnapshots/{docId} {
      allow create: if signedIn() && langAllowed()
        && request.resource.data.answers is map
        && request.resource.data.createdAt is timestamp
        && (
          profileMatch() ||
          !request.resource.data.keys().hasAny(['profileId']) ||
          request.resource.data.profileId == null
        );
      allow read, update, delete: if signedIn()
        && (
          resource.data.profileId == request.auth.uid ||
          !resource.data.keys().hasAny(['profileId']) ||
          resource.data.profileId == null
        );
    }

    match /userJourneys/{docId} {
      allow create: if signedIn() && profileMatch() && langAllowed()
        && request.resource.data.createdAt is timestamp;
      allow read, update, delete: if signedIn()
        && (
          resource.data.profileId == request.auth.uid ||
          !resource.data.keys().hasAny(['profileId']) ||
          resource.data.profileId == null
        );
    }

    match /userAbilityAssessments/{docId} {
      allow read, write: if signedIn()
        && request.resource.data.profileId == request.auth.uid;
    }

    match /userIntentAssessments/{docId} {
      allow read, write: if signedIn()
        && request.resource.data.profileId == request.auth.uid;
    }

    match /userKnowledgeAssessments/{docId} {
      allow read, write: if signedIn()
        && request.resource.data.profileId == request.auth.uid;
    }

    match /userQuestSuggestions/{docId} {
      allow read, write: if signedIn()
        && request.resource.data.profileId == request.auth.uid;
    }

    match /userProgressFacts/{userId} {
      allow read, write: if isOwner(userId);
    }
  }
}
